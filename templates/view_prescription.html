{% extends 'base.html' %}
{% load static %}

{% block title %}Prescription {{ prescription.prescription_id }} - TeleMed{% endblock %}

{% block extra_css %}
<style>
    @media print {

        /* Hide unnecessary elements */
        .navbar,
        footer,
        .btn,
        .alert-warning,
        .no-print {
            display: none !important;
        }

        /* A4 page setup */
        @page {
            size: A4;
            margin: 15mm;
        }

        /* Clean background */
        body,
        html {
            background: white !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Remove page padding */
        div[style*="padding-top: 100px"] {
            padding-top: 0 !important;
            min-height: auto !important;
            background: white !important;
            padding: 0 !important;
        }

        /* Full width container */
        .container,
        div[style*="max-width: 700px"] {
            max-width: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        /* Print container - scales to fit page */
        .print-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Clean prescription card */
        .prescription-card {
            box-shadow: none !important;
            border: 2px solid #333 !important;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .prescription-body {
            flex: 1;
        }

        /* Make header printable */
        .prescription-header {
            background: #e0e0e0 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .prescription-header,
        .prescription-header * {
            color: #333 !important;
        }

        /* Colored sections */
        div[style*="background: var(--primary-50)"],
        div[style*="background: var(--accent-50)"] {
            background: #f5f5f5 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    }

    /* Hide print header on screen */
    .print-header {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div style="padding-top: 100px; min-height: 100vh; background: var(--neutral-50);">
    <div class="container">
        <div style="max-width: 700px; margin: 0 auto;">
            <a href="javascript:history.back()" class="btn btn-ghost btn-sm no-print" style="margin-bottom: 1rem;">
                <i class="fas fa-arrow-left"></i> Back
            </a>

            <div class="prescription-card print-container" id="prescription-content">
                <div class="prescription-header">
                    <h2 style="color: white; margin-bottom: 0.5rem;">
                        <i class="fas fa-prescription"></i> Digital Prescription
                    </h2>
                    <p style="margin: 0; opacity: 0.9;">{{ prescription.prescription_id }}</p>
                </div>

                <div class="prescription-body">
                    <!-- QR Code -->
                    <div
                        style="text-align: center; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--neutral-200);">
                        {% if prescription.qr_code %}
                        <img src="{{ prescription.qr_code.url }}" alt="QR Code" class="qr-code-img"
                            style="width: 100px; height: 100px; border: 3px solid var(--primary-100); border-radius: var(--radius-lg);">
                        {% else %}
                        <div
                            style="width: 100px; height: 100px; margin: 0 auto; background: var(--neutral-100); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-qrcode" style="font-size: 2.5rem; color: var(--neutral-400);"></i>
                        </div>
                        {% endif %}
                        <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.75rem;">Scan to verify</p>
                    </div>

                    <div class="prescription-row">
                        <div class="prescription-label">Patient</div>
                        <div class="prescription-value">{{ prescription.patient.full_name }}</div>
                    </div>

                    <div class="prescription-row">
                        <div class="prescription-label">Prescribed By</div>
                        <div class="prescription-value">
                            Dr. {{ prescription.doctor.full_name }}<br>
                            <span class="text-muted">{{ prescription.doctor.get_specialization_display }} | {{
                                prescription.doctor.qualification }}</span>
                        </div>
                    </div>

                    <div class="prescription-row">
                        <div class="prescription-label">Issue Date</div>
                        <div class="prescription-value">{{ prescription.issue_date }}</div>
                    </div>

                    {% if prescription.valid_until %}
                    <div class="prescription-row">
                        <div class="prescription-label">Valid Until</div>
                        <div class="prescription-value">{{ prescription.valid_until }}</div>
                    </div>
                    {% endif %}

                    <div
                        style="margin: 1rem 0; padding: 0.75rem; background: var(--primary-50); border-radius: var(--radius-lg);">
                        <div style="font-weight: 600; color: var(--primary-700); margin-bottom: 0.5rem;">
                            <i class="fas fa-pills"></i> Medications
                        </div>
                        <div style="white-space: pre-line;">{{ prescription.medications }}</div>
                    </div>

                    <div
                        style="margin: 1rem 0; padding: 0.75rem; background: var(--accent-50); border-radius: var(--radius-lg);">
                        <div style="font-weight: 600; color: var(--accent-700); margin-bottom: 0.5rem;">
                            <i class="fas fa-info-circle"></i> Instructions
                        </div>
                        <div style="white-space: pre-line;">{{ prescription.instructions }}</div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>This is a digital prescription. Take medicines only as prescribed.</span>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 1.5rem; margin-bottom: 4rem;" class="no-print">
                <button onclick="printPrescription()" class="btn btn-secondary">
                    <i class="fas fa-print"></i> Print Prescription
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function printPrescription() {
        // Get the prescription content
        var content = document.getElementById('prescription-content');
        var contentHeight = content.scrollHeight;

        // A4 page height in pixels (at 96 DPI) minus margins
        var pageHeight = 1050; // ~277mm content area

        // Calculate scale factor to fit content in one page
        var scale = 1;
        if (contentHeight > pageHeight) {
            scale = pageHeight / contentHeight;
        }

        // Apply scale for printing
        var style = document.createElement('style');
        style.id = 'print-scale-style';
        style.innerHTML = '@media print { .prescription-card { transform: scale(' + scale + '); transform-origin: top center; } }';
        document.head.appendChild(style);

        // Print
        window.print();

        // Remove scale after print
        setTimeout(function () {
            var el = document.getElementById('print-scale-style');
            if (el) el.remove();
        }, 1000);
    }
</script>
{% endblock %}